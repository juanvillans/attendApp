function uuidv4(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,a="x"==t?e:3&e|8;return a.toString(16)})}function printData(t,e=!1,a){e||(table_container.scrollLeft=history[a].scrollLeft,table_container.scrollTop=history[a].scrollTop),setTimeout(()=>{const a=Date.now();tbody.innerHTML="",thead.innerHTML="",document.getElementById("input_n_classes").value=t.nroClasses,actual_n_classes=t.nroClasses,document.getElementById("input_n_classes").min=t.lastAttendedDay,nro_students=template_th_student.querySelector("#th_nro_students"),nro_students.textContent=`${t.students.length}`;const s=template_th_student.cloneNode(!0),n=document.createDocumentFragment();n.appendChild(s);for(let e=1;e<=t.nroClasses;e++){const t=template_th.querySelector("label");t.title=`marcar toda la columna ${e}`,template_th.querySelector(".marcar_col_input").dataset.col=e-1,t.querySelector("span.text").textContent=e;const a=template_th.cloneNode(!0);n.appendChild(a)}const l=template_th_total.cloneNode(!0);n.append(l),thead.append(n);const o=document.createDocumentFragment();if(t.students.forEach((t,e)=>{const a=template_tr.cloneNode(!0);a.querySelector("tr").dataset.id=t._id,a.querySelector("tr").dataset.index=e,a.querySelector(".each_student_number").textContent=e+1,a.querySelector(".student_name_input").value=t.name;let s=document.createDocumentFragment();t.attendances.forEach((t,e)=>{template_td.querySelector(".each_cell").dataset.col=e,1==t?template_td.querySelector(".each_cell").classList.add("attended"):template_td.querySelector(".each_cell").classList.remove("attended");const a=template_td.cloneNode(!0);s.appendChild(a)}),a.querySelector(".each_total").before(s),calPercentage(t.total,actual_n_classes,a.querySelector(".each_total")),s=null,o.appendChild(a)}),tbody.appendChild(o),e){tbody.style.minWidth="5000px";const t=57*+subjectData.lastAttendedDay;table_container.scrollLeft=t}const c=Date.now();console.log("Print data in : ",(c-a)/1e3)},.2)}function addOrRemoveCells(t){let e=t-actual_n_classes;if(e>0){const e=document.createDocumentFragment(),a=document.createDocumentFragment();for(let s=actual_n_classes;s<t;s++){const t=template_th.querySelector("label");t.title=`marcar toda la columna ${s+1}`,template_th.querySelector(".marcar_col_input").dataset.col=s,t.querySelector("span.text").textContent=s+1;const n=template_th.cloneNode(!0),l=template_td.cloneNode(!0);l.querySelector(".each_cell").dataset.col=s,e.appendChild(n),a.appendChild(l);for(let t=0;t<nro_students.textContent;t++)subjectData.students[t].attendances.push(0)}const s=document.querySelector("thead tr"),n=document.querySelector(".th_total");s.insertBefore(e,n),document.querySelectorAll("tr[data-id]").forEach((e,s)=>{const n=e.querySelector(".each_total");calPercentage(subjectData.students[s].total,t,n),e.insertBefore(a.cloneNode(!0),n)})}if(e<0){const a=document.querySelectorAll(`thead tr > .th_each_colunm:nth-child(n + ${t+2})`),s=document.querySelectorAll(`tr[data-id] > .each_cell:nth-child(n + ${t+2})`);Array.from(a).forEach(t=>t.remove()),Array.from(s).forEach(t=>t.remove()),subjectData.students.forEach((a,s)=>{a.attendances.splice(e,t),calPercentage(a.total,t,all_total_td[s])})}actual_n_classes=t}function calPercentage(t,e,a){let s=t/e*100;s=s%1==0?Math.trunc(s):s.toFixed(1);const n=a.closest("tr");a.textContent=s+"%";const l=n.querySelector(".td_student_name");return s>=75?(l.classList.add("min75"),a.classList.add("min75")):(l.classList.remove("min75"),a.classList.remove("min75")),s}function createNewStudent(){const t=++document.querySelector("#th_nro_students").textContent;nro_students.textContent++;const e=template_tr.cloneNode(!0);subjectData.lastIdStudent+=1,e.querySelector("tr").dataset.id=subjectData.lastIdStudent,e.querySelector("tr").dataset.index=t-1,e.querySelector(".each_student_number").textContent=t;let a=document.createDocumentFragment();for(let t=0;t<actual_n_classes;t++){template_td.querySelector(".each_cell").dataset.col=t;const e=template_td.cloneNode(!0);a.appendChild(e)}e.querySelector(".each_total").before(a),tbody.appendChild(e),subjectData.students.push({_id:subjectData.lastIdStudent,name:"",attendances:new Array(actual_n_classes).fill(0),total:0}),tbody.querySelector(`tr[data-id="${subjectData.lastIdStudent}"] .student_name_input`).focus(),saveHistoryInMemory(),saveInLocalStorage()}function saveHistoryInMemory(){let t=JSON.parse(JSON.stringify(subjectData));t.scrollLeft=table_container.scrollLeft,t.scrollTop=table_container.scrollTop,now<history.length-1?(console.log(history.length-now),history.splice(now+1,history.length-now,t),future.classList.add("disabled"),console.log("esto se ejecutó")):(history.push(t),console.log("y esto tambíen")),past.classList.remove("disabled"),now>25&&history.shift(),now=history.length-1,now<1&&past.classList.add("disabled")}function classDependsTotal(t,e){t>=75?(all_students_name[e].classList.add("min75"),all_total_td[e].classList.add("min75")):(all_students_name[e].classList.remove("min75"),all_total_td[e].classList.remove("min75"))}function goBack(){if(now>0){future.classList.remove("disabled"),now--,printData(history[now],!1,now+1),subjectData=JSON.parse(JSON.stringify(history[now]));const t=data.subjects.findIndex(t=>t._id==subjectData._id);data.subjects[t]=subjectData,saveInLocalStorage()}0==now&&past.classList.add("disabled")}function goNext(){past.classList.remove("disabled"),now++,printData(history[now],!1,now),subjectData=JSON.parse(JSON.stringify(history[now]));const t=data.subjects.findIndex(t=>t._id==subjectData._id);data.subjects[t]=subjectData,saveInLocalStorage(),now==history.length-1&&future.classList.add("disabled")}function printHistory(t){addOrRemoveCells(t[0].asistencia.length),t.forEach((t,e)=>{all_total_td[e].innerHTML=`${t.total}%`,classDependsTotal(t.total,e),t.asistencia.forEach((t,a)=>{let s=all_students_row[e].querySelectorAll(".each_cell")[a];0==t?s.classList.remove("attended"):s.classList.add("attended")})}),input_n_classes.value=actual_n_classes,all_asist_data=t}function saveInLocalStorage(){localStorage.setItem("data",JSON.stringify(data))}const table_container=document.querySelector(".table_container"),thead=document.querySelector("thead tr"),input_n_classes=document.getElementById("input_n_classes"),th_total=document.querySelector(".th_total");let nro_students="";const table=document.querySelector("main"),create_student_btn=document.querySelector(".create_student_btn");let all_students_tr="";const tbody=document.querySelector("tbody"),all_students_name=document.getElementsByClassName("student_name"),select_all_check=document.getElementById("marcar_todos"),past=document.querySelector(".past"),future=document.querySelector(".future"),all_row_check=document.getElementsByClassName(".marcar_fila_input"),select_area=document.querySelector("#select_area");let subjectData={},all_cells=[...document.getElementsByClassName("each_cell")];const all_total_td=document.getElementsByClassName("each_total"),edit_subject_button=document.querySelector("#edit_subject_button");let actual_n_classes=+input_n_classes.value,history=[],now=history.length,data={},selectedSubjectID="";const debounce=(t,e)=>{let a;return(...s)=>{a&&clearTimeout(a),a=setTimeout(()=>{t(...s)},e)}},template_option=document.querySelector("#template_option").content,fetchData=async()=>{function t(){const t=document.createDocumentFragment();data.subjects.map(t=>({name:t.name,_id:t._id})).forEach(e=>{const a=template_option.cloneNode(!0);a.querySelector("option").value=e._id,a.querySelector("option").dataset.id=e._id,a.querySelector("option").textContent=e.name,t.appendChild(a)}),select_area.append(t),subjectData=data.subjects[0],selectedSubjectID=subjectData._id,select_area.value=selectedSubjectID,printData(subjectData,!0),saveHistoryInMemory()}if(data=localStorage.getItem("data"),data)data=JSON.parse(data),console.log("los tados existen en el localstorage",data),t();else try{const e=await fetch("https://attend-app-rho.vercel.app/asistencias/jeje");e.ok?(data=await e.json(),console.log("Datos de la API:",data),null!=data&&(t(),localStorage.setItem("data",JSON.stringify(data)))):console.error("Error en la solicitud:",e.status)}catch(t){console.error("Error en la solicitud:",t)}};fetchData();const template_th_student=document.querySelector("#template_th_student").content,template_th=document.querySelector("#template_th").content,template_th_total=document.querySelector("#template_th_total").content,template_tr=document.querySelector("#template_tr").content,template_td=document.querySelector("#template_td").content;let areYouSureThatDayAlert=!0;table.addEventListener("click",t=>{const e=t.target;if(e.classList.contains("edit_subject_button")){let t=prompt("Nombre de la materia",subjectData.name);null===t||(""===t.trim()?alert("No se puede ingresar un valor vacío."):(select_area.querySelector(`option[data-id="${subjectData._id}"]`).textContent=t,subjectData.name=t,saveInLocalStorage()))}if(e.classList.contains("each_cell")){const t=e.parentElement,s=t.dataset.id,n=t.dataset.index;let l=+e.dataset.col;if(l+1>subjectData.lastAttendedDay+1&&areYouSureThatDayAlert){if(!window.confirm(`¿Y en la clase ${subjectData.lastAttendedDay+1} no vino nadie?`))return;areYouSureThatDayAlert=!1,a()}else a();function a(){e.classList.toggle("attended");let a=subjectData.students[n];a._id!=s&&(a=subjectData.students.find(t=>t._id==s));const o=a.attendances[l];if(1===o?a.total-=1:a.total+=1,calPercentage(a.total,actual_n_classes,t.querySelector(".each_total")),a.attendances[e.dataset.col]=1===o?0:1,l+1>subjectData.lastAttendedDay&&(subjectData.lastAttendedDay=+l+1),l+1==subjectData.lastAttendedDay&&1==o&&!subjectData.students.some(t=>1==t.attendances[l]))for(;l>=0;){if(subjectData.students.some(t=>1==t.attendances[l])){subjectData.lastAttendedDay=+l+1;break}l--}saveHistoryInMemory(),saveInLocalStorage()}}if(e.classList.contains("delete_student_btn")){const t=e.closest("tr");t.classList.add("opacity_1"),document.querySelector("#th_nro_students").textContent--,nro_students.textContent--;const a=t.dataset.id,s=+t.dataset.index;subjectData.students.findIndex(t=>t._id==a);subjectData.students.splice(s,1),saveHistoryInMemory(),saveInLocalStorage(),setTimeout(()=>{t.remove();const e=document.querySelectorAll("tbody tr");for(let t=s;t<e.length;t++){const a=e[t].querySelector(".each_student_number");a.textContent=+t+1,e[t].dataset.index=+t}},150)}"create_student_btn"===e.id&&createNewStudent(),"import_students"===e.id&&(select_area.size=select_area.options.length)}),table.addEventListener("change",t=>{const e=t.target;if("select_area"==e.id)if("newSubjectOption"==e.value){let t=prompt("Escribe el nombre de la nueva materia");if(null===t)select_area.value=selectedSubjectID;else if(""===t.trim())window.alert("No se ha ingresado ningún valor."),select_area.value=selectedSubjectID;else{const a=uuidv4(),s={_id:a,name:t,students:[],nroClasses:24,lastIdStudent:0,lastAttendedDay:0};data.subjects.push(s),subjectData=s;const n=document.createElement("option");n.value=a,n.textContent=t,n.selected=!0,e.append(n),printData(subjectData,!0),history=[],now=0,future.classList.add("disabled"),past.classList.add("disabled"),saveInLocalStorage()}}else subjectData=data.subjects.find(t=>t._id==e.value),printData(subjectData,!0),history=[],now=0,future.classList.add("disabled"),past.classList.add("disabled");if("input_n_classes"===e.id){if(input_n_classes.value>100)return window.alert("El valor no puede ser mayor a 100"),void(input_n_classes.value=actual_n_classes);if(input_n_classes.value<subjectData.lastAttendedDay){if(!window.confirm(`No puede eliminar la columna del dia ${subjectData.lastAttendedDay} porque hay estudiantes registrados asistentes ese dia.\n       Se eliminará hasta la columna ${subjectData.lastAttendedDay+1} en su lugar. ¿Está de acuerdo?`))return void(input_n_classes.value=actual_n_classes);input_n_classes.value=subjectData.lastAttendedDay}subjectData.nroClasses=+e.value,addOrRemoveCells(+input_n_classes.value),saveHistoryInMemory(),saveInLocalStorage()}if(e.classList.contains("marcar_col_input")){let t=+e.dataset.col;if(t+1>subjectData.lastAttendedDay+1&&areYouSureThatDayAlert){if(!window.confirm(`¿Y en la clase ${subjectData.lastAttendedDay+1} no vino nadie?`))return void(e.checked=!1);areYouSureThatDayAlert=!1,a()}else a();function a(){const a=document.querySelectorAll(`.each_cell[data-col="${t}"`);if(e.checked)t+1>subjectData.lastAttendedDay&&(subjectData.lastAttendedDay=t+1),a.forEach((e,a)=>{e.classList.add("attended");let s=subjectData.students[a];s.attendances[t]=1,s.total++,calPercentage(s.total,actual_n_classes,all_total_td[a])});else if(a.forEach((e,a)=>{e.classList.remove("attended");let s=subjectData.students[a];s.attendances[t]=0,s.total--,calPercentage(s.total,actual_n_classes,all_total_td[a])}),t+1==subjectData.lastAttendedDay&&!subjectData.students.some(e=>1==e.attendances[t]))for(;t>=0;){if(subjectData.students.some(e=>1==e.attendances[t])){subjectData.lastAttendedDay=+t+1;break}t--}saveHistoryInMemory(),saveInLocalStorage()}}});const debounceEditStudentName=debounce((t,e)=>{subjectData.students.find(t=>t._id==e).name=t,saveHistoryInMemory(),saveInLocalStorage()},450);table.addEventListener("input",t=>{let e=t.target;if(e.classList.contains("student_name_input")){const t=e.value,a=e.closest("tr"),s=a.dataset.id;console.log("ejee "),debounceEditStudentName(t,s)}});let clonedData="",all_asist_data=[];document.querySelectorAll(".history_arrows").forEach(t=>{t.onclick=(e=>{t.classList.contains("past")&&goBack(),t.classList.contains("future")&&now<history.length-1&&goNext()})}),document.addEventListener("keydown",t=>{if("z"===t.key.toLowerCase()&&t.ctrlKey&&(t.preventDefault(),goBack()),"y"===t.key.toLowerCase()&&t.ctrlKey&&(t.preventDefault(),goNext()),"Enter"===t.key){const e=t.target.closest("tr"),a=+e.dataset.index;a+1==nro_students.textContent&&createNewStudent()}});